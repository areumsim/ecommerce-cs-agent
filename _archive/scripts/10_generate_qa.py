"""훈련 데이터 생성 스크립트.

기존 정책 데이터에서 Q&A 쌍을 자동으로 생성합니다.
"""

import json
import random
from pathlib import Path
from typing import List, Dict, Tuple


# 카테고리별 질문 템플릿
QUESTION_TEMPLATES = {
    "refund": [
        "환불 {topic}이/가 어떻게 되나요?",
        "{topic} 환불 가능한가요?",
        "환불 {topic} 알려주세요",
        "{topic} 환불 받을 수 있나요?",
        "환불 {topic}은 어떻게 처리되나요?",
        "{topic} 환불 절차가 어떻게 되나요?",
        "환불할 때 {topic} 어떻게 해야 하나요?",
    ],
    "shipping": [
        "배송 {topic}이/가 어떻게 되나요?",
        "{topic} 배송되나요?",
        "배송 {topic} 알려주세요",
        "{topic} 배송 가능한가요?",
        "배송 {topic}은 얼마나 걸리나요?",
        "{topic} 배송 비용이 얼마인가요?",
    ],
    "exchange": [
        "교환 {topic}이/가 어떻게 되나요?",
        "{topic} 교환 가능한가요?",
        "교환 {topic} 알려주세요",
        "{topic} 교환하려면 어떻게 해야 하나요?",
        "교환 {topic}은 어떻게 처리되나요?",
    ],
    "payment": [
        "결제 {topic}이/가 어떻게 되나요?",
        "{topic} 결제 가능한가요?",
        "결제 {topic} 알려주세요",
        "{topic} 결제 방법이 있나요?",
        "결제 {topic}은 어떻게 되나요?",
    ],
    "cancel": [
        "주문 취소 {topic}이/가 어떻게 되나요?",
        "{topic} 취소 가능한가요?",
        "취소 {topic} 알려주세요",
        "{topic} 취소하려면 어떻게 해야 하나요?",
    ],
    "order": [
        "주문 {topic}이/가 어떻게 되나요?",
        "{topic} 주문하려면 어떻게 해야 하나요?",
        "주문 {topic} 알려주세요",
        "{topic} 주문 상태 확인 방법",
    ],
    "claim": [
        "클레임 {topic}이/가 어떻게 되나요?",
        "{topic} 불만 접수 방법",
        "클레임 {topic} 알려주세요",
        "{topic} 문제 해결 방법",
    ],
}

# 카테고리별 주제
TOPICS = {
    "refund": [
        "기간", "절차", "수수료", "조건", "방법", "소요 시간",
        "카드 결제", "계좌이체", "현금", "포인트", "쿠폰",
        "부분", "전체", "배송비", "사유", "증빙",
    ],
    "shipping": [
        "기간", "비용", "방법", "추적", "배송지 변경",
        "도서산간", "해외", "퀵배송", "새벽배송", "당일배송",
        "무료배송", "묶음배송", "분할배송", "예약배송",
    ],
    "exchange": [
        "기간", "절차", "조건", "비용", "방법",
        "사이즈", "색상", "다른 상품", "동일 상품",
        "불량", "오배송", "단순변심",
    ],
    "payment": [
        "방법", "수단", "할부", "무이자", "카드",
        "계좌이체", "간편결제", "포인트", "쿠폰", "적립금",
        "복합결제", "영수증", "세금계산서",
    ],
    "cancel": [
        "기간", "방법", "수수료", "환불", "배송 전",
        "배송 중", "부분 취소", "전체 취소",
    ],
    "order": [
        "상태", "내역", "확인", "변경", "추가",
        "배송지", "수량", "옵션", "메모",
    ],
    "claim": [
        "접수", "처리", "보상", "교환", "환불",
        "상담사", "전화", "채팅", "이메일",
    ],
}

# 카테고리별 상세 답변
ANSWERS = {
    "refund": {
        "기간": "상품 수령 후 7일 이내에 환불 신청이 가능합니다. 주문일 기준이 아닌 배송 완료일 기준입니다.",
        "절차": "마이페이지 > 주문내역에서 환불 신청 버튼을 클릭하고, 환불 사유를 선택한 후 반송 방법을 선택하시면 됩니다.",
        "수수료": "단순 변심의 경우 왕복 배송비 5,000원이 고객 부담입니다. 상품 불량이나 오배송의 경우에는 무료입니다.",
        "조건": "상품이 미개봉 상태이고 상품 태그가 부착되어 있어야 하며, 포장이 훼손되지 않아야 합니다.",
        "방법": "택배 수거 또는 직접 발송 중 선택하실 수 있습니다. 택배 수거 시 2-3일 내에 기사님이 방문합니다.",
        "소요 시간": "상품 검수 후 1-3 영업일 내에 환불이 승인되며, 결제 수단에 따라 3-5 영업일 내에 환불됩니다.",
        "카드 결제": "신용카드 결제의 경우 환불 승인 후 카드사 정책에 따라 3-5 영업일 내에 취소 처리됩니다.",
        "계좌이체": "계좌이체 결제의 경우 환불 신청 시 환불받으실 계좌를 입력해 주시면 2-3 영업일 내에 입금됩니다.",
        "현금": "현금 결제의 경우 환불 신청 시 환불받으실 계좌를 입력해 주시면 처리됩니다.",
        "포인트": "포인트로 결제한 경우 환불 시 포인트로 다시 적립됩니다. 유효기간은 기존과 동일하게 유지됩니다.",
        "쿠폰": "쿠폰으로 할인받은 금액은 환불 시 쿠폰이 복원됩니다. 단, 유효기간이 지난 쿠폰은 복원되지 않습니다.",
        "부분": "여러 상품을 주문한 경우 일부 상품만 환불 신청이 가능합니다.",
        "전체": "주문 전체 환불을 원하시면 모든 상품을 선택하여 환불 신청해 주세요.",
        "배송비": "무료배송 혜택을 받은 주문의 경우 부분 환불 시 배송비가 차감될 수 있습니다.",
        "사유": "환불 사유는 단순변심, 상품불량, 오배송, 기타 중 선택하실 수 있습니다.",
        "증빙": "상품 불량의 경우 불량 부분 사진을 첨부해 주시면 빠른 처리가 가능합니다.",
    },
    "shipping": {
        "기간": "일반 배송은 주문 후 2-3일 이내에 도착합니다. 주말/공휴일은 제외됩니다.",
        "비용": "기본 배송비는 3,000원이며, 5만원 이상 구매 시 무료배송입니다.",
        "방법": "택배 배송이 기본이며, 일부 상품은 퀵배송이나 새벽배송도 가능합니다.",
        "추적": "배송 시작 후 마이페이지 또는 문자로 발송된 송장번호로 배송 조회가 가능합니다.",
        "배송지 변경": "배송 전까지는 마이페이지에서 배송지 변경이 가능합니다. 발송 후에는 택배사에 직접 연락해 주세요.",
        "도서산간": "도서산간 지역은 추가 배송비 3,000원이 발생하며, 배송 기간이 1-2일 더 소요될 수 있습니다.",
        "해외": "현재 해외 배송은 지원하지 않습니다. 국내 주소로만 배송 가능합니다.",
        "퀵배송": "서울/수도권 일부 지역에서 퀵배송 서비스를 제공합니다. 추가 비용 5,000원이 발생합니다.",
        "새벽배송": "서울/수도권에서 새벽배송 서비스를 제공합니다. 전날 자정까지 주문 시 다음날 오전 7시 전 도착합니다.",
        "당일배송": "오후 2시 이전 주문 건에 대해 당일배송 서비스를 제공합니다 (서울/수도권 한정).",
        "무료배송": "5만원 이상 구매 시 무료배송입니다. 할인 전 금액 기준으로 계산됩니다.",
        "묶음배송": "동일 판매자의 상품은 묶음배송됩니다. 다른 판매자 상품은 별도 배송됩니다.",
        "분할배송": "재고 상황에 따라 분할배송될 수 있으며, 추가 배송비는 발생하지 않습니다.",
        "예약배송": "원하시는 날짜에 배송받으실 수 있는 예약배송 서비스도 제공합니다.",
    },
    "exchange": {
        "기간": "상품 수령 후 7일 이내에 교환 신청이 가능합니다.",
        "절차": "마이페이지에서 교환 신청 후 상품을 반송해 주시면, 검수 후 새 상품을 발송해 드립니다.",
        "조건": "상품 태그가 부착되어 있고 미사용 상태여야 교환이 가능합니다.",
        "비용": "단순 변심의 경우 왕복 배송비 5,000원이 발생합니다. 불량/오배송은 무료입니다.",
        "방법": "교환 상품은 택배 수거 또는 직접 발송으로 반송하실 수 있습니다.",
        "사이즈": "사이즈 교환은 동일 상품 내에서만 가능합니다. 재고가 없는 경우 환불 처리됩니다.",
        "색상": "색상 교환은 동일 상품 내에서만 가능합니다.",
        "다른 상품": "다른 상품으로의 교환은 불가능합니다. 환불 후 재주문해 주세요.",
        "동일 상품": "동일 상품의 다른 옵션(사이즈, 색상)으로 교환이 가능합니다.",
        "불량": "상품 불량의 경우 사진과 함께 고객센터로 연락해 주시면 무료 교환 처리해 드립니다.",
        "오배송": "오배송의 경우 수거 후 정확한 상품을 다시 발송해 드립니다. 비용은 무료입니다.",
        "단순변심": "단순 변심에 의한 교환은 왕복 배송비 5,000원이 고객 부담입니다.",
    },
    "payment": {
        "방법": "신용카드, 체크카드, 계좌이체, 간편결제(카카오페이, 네이버페이, 토스) 등을 지원합니다.",
        "수단": "다양한 결제 수단을 지원합니다: 카드, 계좌이체, 간편결제, 포인트, 상품권 등",
        "할부": "신용카드 할부는 5만원 이상 결제 시 가능하며, 2~12개월까지 선택하실 수 있습니다.",
        "무이자": "무이자 할부는 제휴 카드사에 한해 2~3개월까지 제공됩니다. 이벤트에 따라 달라질 수 있습니다.",
        "카드": "국내 발급 신용/체크카드 모두 사용 가능합니다. 해외 카드는 일부 제한될 수 있습니다.",
        "계좌이체": "실시간 계좌이체를 지원하며, 결제 즉시 주문이 확정됩니다.",
        "간편결제": "카카오페이, 네이버페이, 토스, 삼성페이 등 간편결제를 지원합니다.",
        "포인트": "적립된 포인트는 1포인트 = 1원으로 사용 가능합니다. 100포인트 이상부터 사용 가능합니다.",
        "쿠폰": "쿠폰은 결제 시 적용하실 수 있으며, 일부 상품/카테고리에는 사용이 제한될 수 있습니다.",
        "적립금": "적립금은 현금처럼 사용 가능하며, 최소 사용 금액 제한이 있을 수 있습니다.",
        "복합결제": "포인트 + 카드, 적립금 + 카드 등 복합결제가 가능합니다.",
        "영수증": "신용카드 매출전표는 마이페이지에서 확인/출력하실 수 있습니다.",
        "세금계산서": "사업자의 경우 세금계산서 발행이 가능합니다. 주문 시 사업자 정보를 입력해 주세요.",
    },
    "cancel": {
        "기간": "배송 전까지 주문 취소가 가능합니다. 발송 후에는 취소가 불가능하며 반품 절차를 이용해 주세요.",
        "방법": "마이페이지 > 주문내역에서 취소 버튼을 클릭하시면 즉시 취소됩니다.",
        "수수료": "결제 취소 수수료는 없습니다. 단, 일부 결제 수단은 취소 처리 시간이 소요될 수 있습니다.",
        "환불": "취소 시 결제 수단에 따라 즉시 또는 1-5 영업일 내에 환불됩니다.",
        "배송 전": "배송 전 주문은 마이페이지에서 직접 취소하실 수 있습니다.",
        "배송 중": "배송이 시작된 후에는 취소가 불가능합니다. 상품 수령 후 반품해 주세요.",
        "부분 취소": "여러 상품 중 일부만 취소도 가능합니다. 단, 무료배송 기준 미달 시 배송비가 발생할 수 있습니다.",
        "전체 취소": "주문 전체 취소를 원하시면 모든 상품을 선택하여 취소해 주세요.",
    },
    "order": {
        "상태": "주문 상태는 마이페이지 > 주문내역에서 확인하실 수 있습니다. 결제완료, 배송준비, 배송중, 배송완료 순으로 진행됩니다.",
        "내역": "주문 내역은 마이페이지에서 최근 1년간의 주문을 확인하실 수 있습니다.",
        "확인": "주문 완료 후 이메일과 문자로 주문 확인 안내가 발송됩니다.",
        "변경": "배송 전까지 배송지, 연락처 등 주문 정보 변경이 가능합니다.",
        "추가": "주문 추가는 불가능합니다. 새로 주문해 주시면 묶음배송이 가능할 수 있습니다.",
        "배송지": "배송지 변경은 발송 전까지 마이페이지에서 가능합니다.",
        "수량": "주문 후 수량 변경은 불가능합니다. 취소 후 재주문해 주세요.",
        "옵션": "주문 후 옵션 변경은 불가능합니다. 취소 후 재주문해 주세요.",
        "메모": "배송 메모는 마이페이지에서 수정하실 수 있습니다.",
    },
    "claim": {
        "접수": "고객센터(1234-5678) 또는 마이페이지 1:1 문의로 클레임을 접수하실 수 있습니다.",
        "처리": "클레임 접수 후 1-2 영업일 내에 담당자가 연락드립니다. 처리 기간은 사안에 따라 다릅니다.",
        "보상": "상품 불량이나 서비스 불만족 시 교환, 환불, 포인트 보상 등으로 처리해 드립니다.",
        "교환": "상품 불량의 경우 무료 교환 처리해 드립니다. 사진 증빙이 필요합니다.",
        "환불": "해결이 어려운 경우 전액 환불 처리해 드립니다.",
        "상담사": "상담사 연결은 평일 09:00-18:00에 가능합니다. 점심시간(12:00-13:00) 제외",
        "전화": "고객센터 전화번호는 1234-5678입니다. 평일 09:00-18:00 운영됩니다.",
        "채팅": "앱 내 채팅 상담은 24시간 가능합니다. 상담사 연결은 운영 시간에만 가능합니다.",
        "이메일": "이메일 문의는 support@example.com으로 보내주세요. 1-2 영업일 내에 답변드립니다.",
    },
}


def generate_qa_pairs() -> List[Dict]:
    """Q&A 쌍 생성."""
    qa_pairs = []

    for category, topics in TOPICS.items():
        templates = QUESTION_TEMPLATES.get(category, [])
        answers = ANSWERS.get(category, {})

        for topic in topics:
            if topic not in answers:
                continue

            answer = answers[topic]

            # 각 템플릿으로 질문 생성
            for template in templates[:3]:  # 템플릿 중 3개만 사용
                question = template.format(topic=topic)

                qa_pairs.append({
                    "instruction": "고객 문의에 친절하고 정확하게 답변하세요.",
                    "input": question,
                    "output": answer,
                    "category": category,
                })

    return qa_pairs


def generate_order_scenarios() -> List[Dict]:
    """주문 관련 시나리오 생성."""
    scenarios = []

    order_states = ["결제완료", "배송준비", "배송중", "배송완료"]
    products = [
        "블루투스 이어폰", "무선 충전기", "스마트워치", "노트북 파우치",
        "USB 허브", "마우스패드", "키보드", "모니터 거치대",
    ]

    for product in products:
        for state in order_states:
            scenarios.append({
                "instruction": "고객의 주문 상태 문의에 답변하세요.",
                "input": f"{product} 주문했는데 지금 어디까지 왔나요?",
                "output": f"고객님, {product} 주문 건 확인해 드렸습니다. 현재 '{state}' 상태입니다. " +
                         ("곧 배송이 시작될 예정입니다." if state == "결제완료" else
                          "오늘 중 발송될 예정입니다." if state == "배송준비" else
                          "배송 조회를 통해 상세 위치를 확인하실 수 있습니다." if state == "배송중" else
                          "상품을 받아보셨나요? 문제가 있으시면 말씀해 주세요."),
                "category": "order_status",
            })

    return scenarios


def generate_claim_scenarios() -> List[Dict]:
    """클레임 시나리오 생성."""
    scenarios = []

    issues = [
        ("상품이 파손되어 왔어요", "불량", "파손 부분 사진을 보내주시면 즉시 새 상품으로 교환해 드리겠습니다. 불편을 드려 죄송합니다."),
        ("주문한 것과 다른 상품이 왔어요", "오배송", "오배송 건 확인해 드렸습니다. 잘못 배송된 상품 수거 후 정확한 상품을 다시 보내드리겠습니다."),
        ("상품 사용법을 모르겠어요", "문의", "상품 사용 가이드를 이메일로 보내드리겠습니다. 추가 궁금하신 점 있으시면 말씀해 주세요."),
        ("배송이 너무 늦어요", "배송지연", "배송 지연에 대해 사과드립니다. 현재 물류 상황을 확인 중이며, 빠른 시일 내에 배송될 수 있도록 조치하겠습니다."),
        ("상품 품질이 기대와 달라요", "품질불만", "상품이 기대에 미치지 못해 죄송합니다. 교환 또는 환불 중 원하시는 방법으로 처리해 드리겠습니다."),
    ]

    for issue, category, response in issues:
        scenarios.append({
            "instruction": "고객 클레임에 공감하며 해결책을 제시하세요.",
            "input": issue,
            "output": response,
            "category": f"claim_{category}",
        })

    return scenarios


def generate_chat_conversations() -> List[Dict]:
    """일반 채팅 대화 생성."""
    conversations = []

    greetings = [
        ("안녕하세요", "안녕하세요! 무엇을 도와드릴까요?"),
        ("저기요", "네, 고객님! 어떤 도움이 필요하신가요?"),
        ("문의 있어요", "네, 편하게 말씀해 주세요. 도움이 필요하신 부분이 있으신가요?"),
    ]

    for input_text, output_text in greetings:
        conversations.append({
            "instruction": "친절하게 고객을 맞이하세요.",
            "input": input_text,
            "output": output_text,
            "category": "greeting",
        })

    farewells = [
        ("감사합니다", "도움이 되셨다니 기쁩니다! 다른 문의사항 있으시면 언제든 연락주세요."),
        ("이게 끝이에요", "네, 추가 문의사항 있으시면 말씀해 주세요. 좋은 하루 되세요!"),
        ("됐어요 고마워요", "감사합니다! 앞으로도 좋은 서비스로 보답하겠습니다."),
    ]

    for input_text, output_text in farewells:
        conversations.append({
            "instruction": "친절하게 대화를 마무리하세요.",
            "input": input_text,
            "output": output_text,
            "category": "farewell",
        })

    return conversations


def main():
    """메인 함수."""
    output_dir = Path("data/training")
    output_dir.mkdir(parents=True, exist_ok=True)

    # 기존 데이터 백업은 하지 않고 새로 생성
    all_data = []

    # Q&A 쌍 생성
    print("정책 Q&A 생성 중...")
    qa_pairs = generate_qa_pairs()
    print(f"  - 생성된 Q&A: {len(qa_pairs)}개")
    all_data.extend(qa_pairs)

    # 주문 시나리오 생성
    print("주문 시나리오 생성 중...")
    order_scenarios = generate_order_scenarios()
    print(f"  - 생성된 시나리오: {len(order_scenarios)}개")
    all_data.extend(order_scenarios)

    # 클레임 시나리오 생성
    print("클레임 시나리오 생성 중...")
    claim_scenarios = generate_claim_scenarios()
    print(f"  - 생성된 시나리오: {len(claim_scenarios)}개")
    all_data.extend(claim_scenarios)

    # 채팅 대화 생성
    print("채팅 대화 생성 중...")
    chat_conversations = generate_chat_conversations()
    print(f"  - 생성된 대화: {len(chat_conversations)}개")
    all_data.extend(chat_conversations)

    # 셔플
    random.shuffle(all_data)

    # 저장
    output_file = output_dir / "generated_qa.jsonl"
    with open(output_file, "w", encoding="utf-8") as f:
        for item in all_data:
            f.write(json.dumps(item, ensure_ascii=False) + "\n")

    print(f"\n총 {len(all_data)}개 데이터 생성 완료!")
    print(f"저장 위치: {output_file}")

    # 카테고리별 통계
    categories = {}
    for item in all_data:
        cat = item["category"]
        categories[cat] = categories.get(cat, 0) + 1

    print("\n카테고리별 통계:")
    for cat, count in sorted(categories.items()):
        print(f"  - {cat}: {count}개")


if __name__ == "__main__":
    main()
